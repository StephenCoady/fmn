<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>fmn.lib.models &#8212; FMN 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for fmn.lib.models</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># Copyright Â© 2013  Red Hat, Inc.</span>
<span class="c1">#</span>
<span class="c1"># This copyrighted material is made available to anyone wishing to use,</span>
<span class="c1"># modify, copy, or redistribute it subject to the terms and conditions</span>
<span class="c1"># of the GNU Lesser General Public License (LGPL) version 2, or</span>
<span class="c1"># (at your option) any later version.  This program is distributed in the</span>
<span class="c1"># hope that it will be useful, but WITHOUT ANY WARRANTY expressed or</span>
<span class="c1"># implied, including the implied warranties of MERCHANTABILITY or FITNESS</span>
<span class="c1"># FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for</span>
<span class="c1"># more details.  You should have received a copy of the GNU Lesser General</span>
<span class="c1"># Public License along with this program; if not, write to the Free</span>
<span class="c1"># Software Foundation, Inc.,</span>
<span class="c1"># 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<span class="c1">#</span>
<span class="c1"># Any Red Hat trademarks that are incorporated in the source</span>
<span class="c1"># code or documentation are not subject to the GNU General Public</span>
<span class="c1"># License and may only be used or replicated with the express permission</span>
<span class="c1"># of Red Hat, Inc.</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Mapping of python classes to Database Tables.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="k">import</span> <span class="n">hybrid_property</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">scoped_session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">relation</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">backref</span>

<span class="kn">import</span> <span class="nn">fedmsg</span>
<span class="kn">import</span> <span class="nn">fedmsg.utils</span>

<span class="kn">import</span> <span class="nn">fmn.lib.defaults</span>


<div class="viewcode-block" id="FMNBase"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.FMNBase">[docs]</a><span class="k">class</span> <span class="nc">FMNBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="FMNBase.notify"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.FMNBase.notify">[docs]</a>    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">openid</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">changed</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">obj</span> <span class="o">+</span> <span class="s2">&quot;.update&quot;</span>
        <span class="n">fedmsg</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
            <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span>
            <span class="n">msg</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">openid</span><span class="o">=</span><span class="n">openid</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
                <span class="n">changed</span><span class="o">=</span><span class="n">changed</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div></div>


<span class="n">BASE</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">(</span><span class="n">cls</span><span class="o">=</span><span class="n">FMNBase</span><span class="p">)</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="init"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.init">[docs]</a><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">db_url</span><span class="p">,</span> <span class="n">alembic_ini</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create the tables in the database using the information from the</span>
<span class="sd">    url obtained.</span>

<span class="sd">    :arg db_url, URL used to connect to the database. The URL contains</span>
<span class="sd">        information with regards to the database engine, the host to</span>
<span class="sd">        connect to, the user and password and the database name.</span>
<span class="sd">          ie: &lt;engine&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;/&lt;dbname&gt;</span>
<span class="sd">    :kwarg alembic_ini, path to the alembic ini file. This is necessary</span>
<span class="sd">        to be able to use alembic correctly, but not for the unit-tests.</span>
<span class="sd">    :kwarg debug, a boolean specifying wether we should have the verbose</span>
<span class="sd">        output of sqlalchemy or not.</span>
<span class="sd">    :return a session that can be used to query the database.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">db_url</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
        <span class="n">BASE</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

    <span class="c1"># This... &quot;causes problems&quot;</span>
    <span class="c1">#if db_url.startswith(&#39;sqlite:&#39;):</span>
    <span class="c1">#    def _fk_pragma_on_connect(dbapi_con, con_record):</span>
    <span class="c1">#        dbapi_con.execute(&#39;pragma foreign_keys=ON&#39;)</span>
    <span class="c1">#    sa.event.listen(engine, &#39;connect&#39;, _fk_pragma_on_connect)</span>

    <span class="k">if</span> <span class="n">alembic_ini</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="c1"># then, load the Alembic configuration and generate the</span>
        <span class="c1"># version table, &quot;stamping&quot; it with the most recent rev:</span>
        <span class="kn">from</span> <span class="nn">alembic.config</span> <span class="k">import</span> <span class="n">Config</span>
        <span class="kn">from</span> <span class="nn">alembic</span> <span class="k">import</span> <span class="n">command</span>
        <span class="n">alembic_cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">alembic_ini</span><span class="p">)</span>
        <span class="n">command</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">alembic_cfg</span><span class="p">,</span> <span class="s2">&quot;head&quot;</span><span class="p">)</span>

    <span class="n">scopedsession</span> <span class="o">=</span> <span class="n">scoped_session</span><span class="p">(</span><span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">scopedsession</span></div>


<div class="viewcode-block" id="Context"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Context">[docs]</a><span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">BASE</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;contexts&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>
    <span class="n">detail_name</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">icon</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">placeholder</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;detail_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">detail_name</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;created_on&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_on</span><span class="p">,</span>
            <span class="s1">&#39;icon&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon</span><span class="p">,</span>
            <span class="s1">&#39;placeholder&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">placeholder</span><span class="p">,</span>
        <span class="p">}</span>

<div class="viewcode-block" id="Context.get_confirmation"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Context.get_confirmation">[docs]</a>    <span class="k">def</span> <span class="nf">get_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">openid</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">confirmation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirmations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">openid</span> <span class="o">==</span> <span class="n">openid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">confirmation</span>

        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Context.by_name"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Context.by_name">[docs]</a>    <span class="k">def</span> <span class="nf">by_name</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></div>

    <span class="n">get</span> <span class="o">=</span> <span class="n">by_name</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Context.by_user"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Context.by_user">[docs]</a>    <span class="k">def</span> <span class="nf">by_user</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">cls</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Preference</span><span class="p">,</span>
            <span class="n">User</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">User</span><span class="o">.</span><span class="n">openid</span> <span class="o">==</span> <span class="n">openid</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Context.all"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Context.all">[docs]</a>    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Context.create"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Context.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span>
               <span class="n">detail_name</span><span class="p">,</span> <span class="n">icon</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                      <span class="n">detail_name</span><span class="o">=</span><span class="n">detail_name</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="n">icon</span><span class="p">,</span>
                      <span class="n">placeholder</span><span class="o">=</span><span class="n">placeholder</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">context</span></div></div>


<div class="viewcode-block" id="User"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.User">[docs]</a><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BASE</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span>

    <span class="n">openid</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">openid_url</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># doesn&#39;t have to be unique, because we&#39;ll require the openid url, too.</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;openid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span>
            <span class="s1">&#39;openid_url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">openid_url</span><span class="p">,</span>
            <span class="s1">&#39;created_on&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_on</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;fmn.lib.models.User: </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">openid_url</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="User.by_openid"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.User.by_openid">[docs]</a>    <span class="k">def</span> <span class="nf">by_openid</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">openid</span><span class="o">=</span><span class="n">openid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></div>

    <span class="n">get</span> <span class="o">=</span> <span class="n">by_openid</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="User.all"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.User.all">[docs]</a>    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>

<div class="viewcode-block" id="User.reset_api_key"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.User.reset_api_key">[docs]</a>    <span class="k">def</span> <span class="nf">reset_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="User.get_or_create"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.User.get_or_create">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="p">,</span> <span class="n">openid_url</span><span class="p">,</span>
                      <span class="n">create_defaults</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">detail_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">by_openid</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="p">,</span> <span class="n">openid_url</span><span class="p">,</span>
                              <span class="n">create_defaults</span><span class="p">,</span> <span class="n">detail_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="User.create"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.User.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="p">,</span> <span class="n">openid_url</span><span class="p">,</span>
               <span class="n">create_defaults</span><span class="p">,</span> <span class="n">detail_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span>
            <span class="n">openid</span><span class="o">=</span><span class="n">openid</span><span class="p">,</span>
            <span class="n">openid_url</span><span class="o">=</span><span class="n">openid_url</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">create_defaults</span><span class="p">:</span>
            <span class="n">fmn</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">create_defaults_for</span><span class="p">(</span>
                <span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">detail_values</span><span class="o">=</span><span class="n">detail_values</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">user</span></div></div>


<div class="viewcode-block" id="Rule"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Rule">[docs]</a><span class="k">class</span> <span class="nc">Rule</span><span class="p">(</span><span class="n">BASE</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;rules&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>

    <span class="n">filter_id</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;filters.id&#39;</span><span class="p">))</span>
    <span class="nb">filter</span> <span class="o">=</span> <span class="n">relation</span><span class="p">(</span>
        <span class="s1">&#39;Filter&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;rules&#39;</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Rule.created_on&#39;</span><span class="p">)))</span>

    <span class="c1"># This is something of the form &#39;fmn.rules:some_function&#39;</span>
    <span class="c1"># We need to do major validation to make sure only *our* code_paths</span>
    <span class="c1"># make it in the database.</span>
    <span class="n">code_path</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># JSON-encoded kw</span>
    <span class="n">_arguments</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
    <span class="c1"># Should we negate the output of the computed rule?</span>
    <span class="n">negated</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;created_on&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_on</span><span class="p">,</span>
            <span class="s1">&#39;code_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_path</span><span class="p">,</span>
            <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span>
            <span class="s1">&#39;cache_key&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_key</span><span class="p">,</span>
            <span class="s1">&#39;negated&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">negated</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">reify</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fedmsg</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">load_class</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">negation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negated</span> <span class="ow">and</span> <span class="s1">&#39;!&#39;</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;fmn.lib.models.Rule: </span><span class="si">%s%r</span><span class="s2">(**</span><span class="si">%r</span><span class="s2">)&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">negation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">((</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_path</span> <span class="o">+</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arguments</span>
        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_arguments</span><span class="p">)</span>

    <span class="nd">@arguments</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arguments</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Rule.validate_code_path"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Rule.validate_code_path">[docs]</a>    <span class="k">def</span> <span class="nf">validate_code_path</span><span class="p">(</span><span class="n">valid_paths</span><span class="p">,</span> <span class="n">code_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Raise an exception if code_path is not one of our</span>
<span class="sd">        whitelisted valid_paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">root</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">code_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_paths</span><span class="p">[</span><span class="n">root</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> is not a valid code_path&quot;</span> <span class="o">%</span> <span class="n">code_path</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Rule.create_from_code_path"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Rule.create_from_code_path">[docs]</a>    <span class="k">def</span> <span class="nf">create_from_code_path</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">valid_paths</span><span class="p">,</span> <span class="n">code_path</span><span class="p">,</span>
                              <span class="n">negated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>

        <span class="c1"># This will raise an exception if invalid</span>
        <span class="n">Rule</span><span class="o">.</span><span class="n">validate_code_path</span><span class="p">(</span><span class="n">valid_paths</span><span class="p">,</span> <span class="n">code_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="n">rule</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">code_path</span><span class="o">=</span><span class="n">code_path</span><span class="p">,</span> <span class="n">negated</span><span class="o">=</span><span class="n">negated</span><span class="p">)</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">kw</span>

        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rule</span></div>

<div class="viewcode-block" id="Rule.set_argument"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Rule.set_argument">[docs]</a>    <span class="k">def</span> <span class="nf">set_argument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>
        <span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">preference</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">preference</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rule.title"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Rule.title">[docs]</a>    <span class="k">def</span> <span class="nf">title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valid_paths</span><span class="p">):</span>
        <span class="n">root</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">valid_paths</span><span class="p">[</span><span class="n">root</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Rule.doc"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Rule.doc">[docs]</a>    <span class="k">def</span> <span class="nf">doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valid_paths</span><span class="p">,</span> <span class="n">no_links</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">root</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">no_links</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">valid_paths</span><span class="p">[</span><span class="n">root</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;doc-no-links&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">valid_paths</span><span class="p">[</span><span class="n">root</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="Filter"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Filter">[docs]</a><span class="k">class</span> <span class="nc">Filter</span><span class="p">(</span><span class="n">BASE</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;filters&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">oneshot</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">preference_id</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;preferences.id&#39;</span><span class="p">))</span>
    <span class="n">preference</span> <span class="o">=</span> <span class="n">relation</span><span class="p">(</span><span class="s1">&#39;Preference&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;filters&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;created_on&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_on</span><span class="p">,</span>
            <span class="s1">&#39;rules&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">__json__</span><span class="p">(</span><span class="n">reify</span><span class="o">=</span><span class="n">reify</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">],</span>
            <span class="s1">&#39;oneshot&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oneshot</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;fmn.lib.models.Filter: </span><span class="si">%r</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Filter.create"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Filter.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">filter</span></div>

<div class="viewcode-block" id="Filter.fired"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Filter.fired">[docs]</a>    <span class="k">def</span> <span class="nf">fired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oneshot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="n">pref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preference</span>
            <span class="k">if</span> <span class="n">pref</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">pref</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="n">pref</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;filters&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Filter.get_rule"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Filter.get_rule">[docs]</a>    <span class="k">def</span> <span class="nf">get_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">code_path</span><span class="p">,</span> <span class="n">rule_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">code_path</span> <span class="o">==</span> <span class="n">code_path</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">rule_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No such rule found: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">code_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Filter.has_rule"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Filter.has_rule">[docs]</a>    <span class="k">def</span> <span class="nf">has_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">code_path</span><span class="p">,</span> <span class="n">rule_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">code_path</span> <span class="o">==</span> <span class="n">code_path</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">rule_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Filter.add_rule"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Filter.add_rule">[docs]</a>    <span class="k">def</span> <span class="nf">add_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="o">.</span><span class="n">create_from_code_path</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kw</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot handle rule with non-empty kw&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">pref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preference</span>
        <span class="k">if</span> <span class="n">pref</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">pref</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="n">pref</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;rules&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rule</span></div>

<div class="viewcode-block" id="Filter.remove_rule"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Filter.remove_rule">[docs]</a>    <span class="k">def</span> <span class="nf">remove_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">code_path</span><span class="p">,</span> <span class="n">rule_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">code_path</span> <span class="o">==</span> <span class="n">code_path</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">rule_id</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">pref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preference</span>
                <span class="k">if</span> <span class="n">pref</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">pref</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="n">pref</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;rules&quot;</span><span class="p">)</span>

                <span class="k">return</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No such rule found: </span><span class="si">%r</span><span class="s2"> with id=</span><span class="si">%d</span><span class="s2">&quot;</span>
                         <span class="o">%</span> <span class="p">(</span><span class="n">code_path</span><span class="p">,</span> <span class="n">rule_id</span><span class="p">))</span></div>

<div class="viewcode-block" id="Filter.negate_rule"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Filter.negate_rule">[docs]</a>    <span class="k">def</span> <span class="nf">negate_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">code_path</span><span class="p">,</span> <span class="n">rule_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">code_path</span> <span class="o">==</span> <span class="n">code_path</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">rule_id</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">negated</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">negated</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">pref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preference</span>
                <span class="k">if</span> <span class="n">pref</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">pref</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="n">pref</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;rules&quot;</span><span class="p">)</span>

                <span class="k">return</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No such rule found: </span><span class="si">%r</span><span class="s2"> with id=</span><span class="si">%d</span><span class="s2">&quot;</span>
                         <span class="o">%</span> <span class="p">(</span><span class="n">code_path</span><span class="p">,</span> <span class="n">rule_id</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="DetailValue"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.DetailValue">[docs]</a><span class="k">class</span> <span class="nc">DetailValue</span><span class="p">(</span><span class="n">BASE</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;detail_values&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">preference_id</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;preferences.id&#39;</span><span class="p">))</span>
    <span class="n">preference</span> <span class="o">=</span> <span class="n">relation</span><span class="p">(</span><span class="s1">&#39;Preference&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;detail_values&#39;</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="DetailValue.get"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.DetailValue.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">value</span><span class="o">==</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="DetailValue.create"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.DetailValue.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="DetailValue.exists"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.DetailValue.exists">[docs]</a>    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span>
            <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Confirmation</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Confirmation</span><span class="o">.</span><span class="n">detail_value</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="Preference"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference">[docs]</a><span class="k">class</span> <span class="nc">Preference</span><span class="p">(</span><span class="n">BASE</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;preferences&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>

    <span class="c1"># Number of seconds that have elapsed since the earliest queued message</span>
    <span class="c1"># before we send a digest over whatever medium.</span>
    <span class="n">batch_delta</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Number of messages that are queued before we send a digest over whatever</span>
    <span class="c1"># medium.</span>
    <span class="n">batch_count</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Hold the state of start/stop commands to the irc bot and others.</span>
    <span class="c1"># Disabled by default so that we can provide robust default filters without</span>
    <span class="c1"># forcing new users into an opt-out situation.</span>
    <span class="n">enabled</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Various presentation booleans</span>
    <span class="n">markup_messages</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">triggered_by_links</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">shorten_links</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">openid</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;users.openid&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">context_name</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;contexts.name&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">relation</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;preferences&#39;</span><span class="p">))</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">relation</span><span class="p">(</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;preferences&#39;</span><span class="p">))</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;openid&#39;</span><span class="p">,</span> <span class="s1">&#39;context_name&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;created_on&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_on</span><span class="p">,</span>
            <span class="s1">&#39;batch_delta&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_delta</span><span class="p">,</span>
            <span class="s1">&#39;batch_count&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_count</span><span class="p">,</span>
            <span class="s1">&#39;markup_messages&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">markup_messages</span><span class="p">,</span>
            <span class="s1">&#39;triggered_by_links&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggered_by_links</span><span class="p">,</span>
            <span class="s1">&#39;shorten_links&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shorten_links</span><span class="p">,</span>
            <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
            <span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">__json__</span><span class="p">(</span><span class="n">reify</span><span class="o">=</span><span class="n">reify</span><span class="p">),</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">__json__</span><span class="p">(</span><span class="n">reify</span><span class="o">=</span><span class="n">reify</span><span class="p">),</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">f</span><span class="o">.</span><span class="n">__json__</span><span class="p">(</span><span class="n">reify</span><span class="o">=</span><span class="n">reify</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">active</span><span class="p">],</span>
            <span class="s1">&#39;detail_values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">detail_values</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;fmn.lib.models.Preference: </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">can_send</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detail_values</span><span class="p">)</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">detail_name</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">should_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If the user has any batching preferences at all, then we should &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_delta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Preference.list_batching"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.list_batching">[docs]</a>    <span class="k">def</span> <span class="nf">list_batching</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">batch_delta</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">batch_count</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>

<div class="viewcode-block" id="Preference.set_batch_values"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.set_batch_values">[docs]</a>    <span class="k">def</span> <span class="nf">set_batch_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_delta</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_count</span> <span class="o">=</span> <span class="n">count</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;batch_values&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Preference.set_markup_messages"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.set_markup_messages">[docs]</a>    <span class="k">def</span> <span class="nf">set_markup_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">markup_messages</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;markup_messages&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Preference.set_triggered_by_links"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.set_triggered_by_links">[docs]</a>    <span class="k">def</span> <span class="nf">set_triggered_by_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggered_by_links</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;triggered_by_links&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Preference.set_shorten_links"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.set_shorten_links">[docs]</a>    <span class="k">def</span> <span class="nf">set_shorten_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shorten_links</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;shorten_links&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Preference.set_verbose"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.set_verbose">[docs]</a>    <span class="k">def</span> <span class="nf">set_verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;verbose&quot;</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Preference.by_user"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.by_user">[docs]</a>    <span class="k">def</span> <span class="nf">by_user</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">cls</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">openid</span> <span class="o">==</span> <span class="n">openid</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">context_name</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Preference.by_detail"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.by_detail">[docs]</a>    <span class="k">def</span> <span class="nf">by_detail</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">detail_value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">DetailValue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">detail_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">preference</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Preference.create"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">detail_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">User</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">by_openid</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Context</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">pref</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>
        <span class="n">pref</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">pref</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>

        <span class="k">if</span> <span class="n">detail_value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">DetailValue</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">detail_value</span><span class="p">)</span>
            <span class="n">pref</span><span class="o">.</span><span class="n">detail_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">pref</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pref</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pref</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Preference.get_or_create"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.get_or_create">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="o">=</span><span class="n">openid</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No such user </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">openid</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Preference.load"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;openid&#39;</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">openid</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">name</span>

        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">openid</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">context_name</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">first</span><span class="p">()</span></div>

<div class="viewcode-block" id="Preference.delete_details"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.delete_details">[docs]</a>    <span class="k">def</span> <span class="nf">delete_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">detail_value</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Deleting </span><span class="si">%r</span><span class="s2"> from </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">detail_value</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
        <span class="n">detail_value</span> <span class="o">=</span> <span class="n">detail_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">DetailValue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">detail_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detail_values</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;details&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Preference.update_details"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.update_details">[docs]</a>    <span class="k">def</span> <span class="nf">update_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">detail_value</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding </span><span class="si">%r</span><span class="s2"> to </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">detail_value</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
        <span class="n">detail_value</span> <span class="o">=</span> <span class="n">detail_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">DetailValue</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">detail_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detail_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;details&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Preference.set_enabled"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.set_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">set_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">enabled</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">enabled</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;enabled&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Preference.delete_filter"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.delete_filter">[docs]</a>    <span class="k">def</span> <span class="nf">delete_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">):</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_name</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;filters&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Preference.add_filter"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.add_filter">[docs]</a>    <span class="k">def</span> <span class="nf">add_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">notify</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;filters&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Preference.set_filter_active"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.set_filter_active">[docs]</a>    <span class="k">def</span> <span class="nf">set_filter_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">,</span> <span class="n">active</span><span class="p">):</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_name</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">)</span>
        <span class="nb">filter</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">active</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;filters&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Preference.set_filter_oneshot"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.set_filter_oneshot">[docs]</a>    <span class="k">def</span> <span class="nf">set_filter_oneshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">,</span> <span class="n">oneshot</span><span class="p">):</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_name</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">)</span>
        <span class="nb">filter</span><span class="o">.</span><span class="n">oneshot</span> <span class="o">=</span> <span class="n">oneshot</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;filters&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Preference.has_filter_name"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.has_filter_name">[docs]</a>    <span class="k">def</span> <span class="nf">has_filter_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">filter</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">filter_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Preference.get_filter_name"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.get_filter_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_filter_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">filter</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">filter_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">filter</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No such filter </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filter_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Preference.has_filter"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.has_filter">[docs]</a>    <span class="k">def</span> <span class="nf">has_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">filter_id</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">filter</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">filter_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Preference.get_filter"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Preference.get_filter">[docs]</a>    <span class="k">def</span> <span class="nf">get_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">filter_id</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">filter</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">filter_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">filter</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No such filter </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filter_id</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="hash_producer"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.hash_producer">[docs]</a><span class="k">def</span> <span class="nf">hash_producer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a random hash for a confirmation secret. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>


<div class="viewcode-block" id="Confirmation"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Confirmation">[docs]</a><span class="k">class</span> <span class="nc">Confirmation</span><span class="p">(</span><span class="n">BASE</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;confirmations&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>

    <span class="n">STATUSES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;accepted&#39;</span><span class="p">,</span> <span class="s1">&#39;rejected&#39;</span><span class="p">,</span> <span class="s1">&#39;invalid&#39;</span><span class="p">]</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span><span class="p">)</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="n">hash_producer</span><span class="p">)</span>
    <span class="n">detail_value</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>

    <span class="n">openid</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;users.openid&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">context_name</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;contexts.name&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">relation</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;confirmations&#39;</span><span class="p">))</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">relation</span><span class="p">(</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;confirmations&#39;</span><span class="p">))</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;openid&#39;</span><span class="p">,</span> <span class="s1">&#39;context_name&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;fmn.lib.models.Confirmation: </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Confirmation.create"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Confirmation.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">detail_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">openid</span><span class="p">,</span> <span class="n">User</span><span class="p">):</span>
            <span class="n">openid</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">by_openid</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Context</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">confirmation</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>
        <span class="n">confirmation</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">openid</span>
        <span class="n">confirmation</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>

        <span class="n">confirmation</span><span class="o">.</span><span class="n">detail_value</span> <span class="o">=</span> <span class="n">detail_value</span>

        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">confirmation</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Confirmation.get_or_create"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Confirmation.get_or_create">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="o">=</span><span class="n">openid</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No such user </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">openid</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Confirmation.load"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Confirmation.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;openid&#39;</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">openid</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">name</span>

        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">openid</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">context_name</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">first</span><span class="p">()</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Confirmation.by_detail"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Confirmation.by_detail">[docs]</a>    <span class="k">def</span> <span class="nf">by_detail</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">context_name</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">detail_value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">all</span><span class="p">()</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Confirmation.by_secret"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Confirmation.by_secret">[docs]</a>    <span class="k">def</span> <span class="nf">by_secret</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">secret</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">secret</span><span class="o">=</span><span class="n">secret</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Confirmation.list_pending"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Confirmation.list_pending">[docs]</a>    <span class="k">def</span> <span class="nf">list_pending</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;pending&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Confirmation.delete_expired"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Confirmation.delete_expired">[docs]</a>    <span class="k">def</span> <span class="nf">delete_expired</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="n">too_old</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">expired</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">created_on</span> <span class="o">&lt;</span> <span class="n">too_old</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">expired</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting </span><span class="si">%i</span><span class="s2"> expired confirmations&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">expired</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">confirmation</span> <span class="ow">in</span> <span class="n">expired</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Confirmation.set_value"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Confirmation.set_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detail_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Confirmation.set_status"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.Confirmation.set_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">status</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUSES</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting </span><span class="si">%r</span><span class="s2"> status to </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

        <span class="c1"># Propagate back to the Preference if everything is good.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;accepted&#39;</span><span class="p">:</span>
            <span class="n">pref</span> <span class="o">=</span> <span class="n">Preference</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">)</span>
            <span class="n">pref</span><span class="o">.</span><span class="n">update_details</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detail_value</span><span class="p">)</span>

        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_name</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="QueuedMessage"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.QueuedMessage">[docs]</a><span class="k">class</span> <span class="nc">QueuedMessage</span><span class="p">(</span><span class="n">BASE</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;queued_messages&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>

    <span class="n">_message</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fedmsg</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_message</span><span class="p">)</span>

    <span class="nd">@message</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_message</span> <span class="o">=</span> <span class="n">fedmsg</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>

    <span class="n">openid</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;users.openid&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">context_name</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;contexts.name&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">relation</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;queued_messages&#39;</span><span class="p">))</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">relation</span><span class="p">(</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;queued_messages&#39;</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="QueuedMessage.enqueue"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.QueuedMessage.enqueue">[docs]</a>    <span class="k">def</span> <span class="nf">enqueue</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">User</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">by_openid</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">openid</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">Context</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">queued_message</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span>
            <span class="n">openid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">openid</span><span class="p">,</span>
            <span class="n">context_name</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">queued_message</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">queued_message</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">queued_message</span></div>

<div class="viewcode-block" id="QueuedMessage.dequeue"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.QueuedMessage.dequeue">[docs]</a>    <span class="k">def</span> <span class="nf">dequeue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="QueuedMessage.earliest_for"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.QueuedMessage.earliest_for">[docs]</a>    <span class="k">def</span> <span class="nf">earliest_for</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">openid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">openid</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">context_name</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">created_on</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">first</span><span class="p">()</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="QueuedMessage.list_for"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.QueuedMessage.list_for">[docs]</a>    <span class="k">def</span> <span class="nf">list_for</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">openid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">openid</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">context_name</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">created_on</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">all</span><span class="p">()</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="QueuedMessage.count_for"><a class="viewcode-back" href="../../../reference/fmn.lib.html#fmn.lib.models.QueuedMessage.count_for">[docs]</a>    <span class="k">def</span> <span class="nf">count_for</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">openid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">openid</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">context_name</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">count</span><span class="p">()</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../lib.html">fmn.lib</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Red Hat, Inc. and others.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>